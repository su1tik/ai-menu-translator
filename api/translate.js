import { GoogleGenerativeAI } from "@google/generative-ai";

export default async function handler(req, res) {
  // 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CORS (—á—Ç–æ–±—ã —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –º–æ–≥ –ø–æ–ª—É—á–∞—Ç—å –æ—Ç–≤–µ—Ç)
  res.setHeader("Access-Control-Allow-Credentials", true);
  res.setHeader("Access-Control-Allow-Origin", "*");
  res.setHeader(
    "Access-Control-Allow-Methods",
    "GET,OPTIONS,PATCH,DELETE,POST,PUT"
  );
  res.setHeader(
    "Access-Control-Allow-Headers",
    "X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version"
  );

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –±—Ä–∞—É–∑–µ—Ä–∞ (OPTIONS)
  if (req.method === "OPTIONS") {
    res.status(200).end();
    return;
  }

  // –†–∞–∑—Ä–µ—à–∞–µ–º —Ç–æ–ª—å–∫–æ POST –∑–∞–ø—Ä–æ—Å—ã
  if (req.method !== "POST") {
    return res.status(405).json({ error: "Method not allowed" });
  }

  try {
    const apiKey = process.env.GEMINI_API_KEY;
    if (!apiKey) {
      console.error("‚ùå GEMINI_API_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω");
      return res.status(500).json({ error: "Server Configuration Error" });
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Gemini
    const genAI = new GoogleGenerativeAI(apiKey);
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–±–∏–ª—å–Ω—É—é –±—ã—Å—Ç—Ä—É—é –º–æ–¥–µ–ª—å (1.5-flash)
    const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });

    const { text, source, target } = req.body;

    if (!text) {
      return res.status(400).json({ error: "–¢–µ–∫—Å—Ç –Ω–µ —É–∫–∞–∑–∞–Ω" });
    }

    // === –¢–í–û–ò –ü–†–û–ú–ü–¢–´ (–°–ö–û–ü–ò–†–û–í–ê–ù–û –ò–ó server/index.js) ===
    let prompt = "";

    // üáπüá∑ –¢—É—Ä–µ—Ü–∫–∏–π —è–∑—ã–∫
    if (target === "tr") {
      prompt = `
–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–Ω—ã—Ö –º–µ–Ω—é.
–ü–µ—Ä–µ–≤–µ–¥–∏ —Ç–µ–∫—Å—Ç —Å—Ç—Ä–æ–≥–æ –Ω–∞ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–π —Ç—É—Ä–µ—Ü–∫–∏–π —è–∑—ã–∫ (–ª–∞—Ç–∏–Ω–∏—Ü–∞).
–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –∫–∞–∑–∞—Ö—Å–∫–∏–µ —Å–ª–æ–≤–∞, —Å–æ—Ö—Ä–∞–Ω—è–π —Å—Ç–∏–ª—å –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–µ–∫—Å—Ç–∞.
–°–æ—Ö—Ä–∞–Ω–∏ –ø—É–Ω–∫—Ç—É–∞—Ü–∏—é, –∑–∞–≥–ª–∞–≤–Ω—ã–µ –±—É–∫–≤—ã, —Å–∫–æ–±–∫–∏, —Å–∏–º–≤–æ–ª—ã –∏ –ø—Ä–æ–±–µ–ª—ã.
–ù–µ –¥–æ–±–∞–≤–ª—è–π –ø–æ—è—Å–Ω–µ–Ω–∏–π, –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–≤–µ–¥–∏ —Ç–µ–∫—Å—Ç.

–¢–µ–∫—Å—Ç –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞:
${text}
`;
    }

    // üá∞üáø –ö–∞–∑–∞—Ö—Å–∫–∏–π —è–∑—ã–∫ (–¢–≤–æ–π —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫)
    else if (target === "kk") {
      prompt = `
–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–Ω—ã—Ö –º–µ–Ω—é.
–ü–µ—Ä–µ–≤–µ–¥–∏ –Ω–∞–∑–≤–∞–Ω–∏—è –±–ª—é–¥ –∏ –æ–ø–∏—Å–∞–Ω–∏—è –Ω–∞ –∫–∞–∑–∞—Ö—Å–∫–∏–π —è–∑—ã–∫ —Ç–∞–∫, —á—Ç–æ–±—ã –∑–≤—É—á–∞–ª–æ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ.
–°–æ—Ö—Ä–∞–Ω–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É, –ø—É–Ω–∫—Ç—É–∞—Ü–∏—é, –ø—Ä–æ–±–µ–ª—ã, –∑–∞–≥–ª–∞–≤–Ω—ã–µ –±—É–∫–≤—ã –∏ —Å–∏–º–≤–æ–ª—ã.
–ù–µ –¥–æ–±–∞–≤–ª—è–π –ø–æ—è—Å–Ω–µ–Ω–∏–π –∏–ª–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–ª–æ–≤.
–ò—Å–ø–æ–ª—å–∑—É–π —Å–ª–µ–¥—É—é—â–∏–µ –ø–µ—Ä–µ–≤–æ–¥—ã, –µ—Å–ª–∏ –æ–Ω–∏ –≤—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è:

–†—ã–±–∞:
- –õ–æ—Å–æ—Å—å ‚Üí –ê–ª–±—ã—Ä—Ç
- –°–µ–º–≥–∞ ‚Üí –ê“õ—Å–µ—Ä–∫–µ
- –°—É–¥–∞–∫ ‚Üí –ö”©–∫—Å–µ—Ä–∫–µ
- –§–æ—Ä–µ–ª—å ‚Üí –ë–∞“õ—Ç–∞“õ
- –û—Å–µ—Ç—Ä ‚Üí –ë–µ–∫—ñ—Ä–µ
- –°–∞–∑–∞–Ω ‚Üí –°–∞–∑–∞–Ω –±–∞–ª—ã“õ
- –£–≥–æ—Ä—å ‚Üí –ñ—ã–ª–∞–Ω–±–∞–ª—ã“õ

–ú–æ—Ä–µ–ø—Ä–æ–¥—É–∫—Ç—ã:
- –ö—Ä–µ–≤–µ—Ç–∫–∞ ‚Üí –ê—Å—à–∞—è–Ω
- –ú–∏–¥–∏—è ‚Üí –ú–∏–¥–∏—è
- –£—Å—Ç—Ä–∏—Ü–∞ ‚Üí –£—Å—Ç—Ä–∏—Ü–∞
- –ö—Ä–∞–± ‚Üí –¢–µ“£—ñ–∑ —à–∞—è–Ω—ã
- –†–∞–∫ ‚Üí –°—É —à–∞—è–Ω

–û–≤–æ—â–∏:
- –ë–∞–∫–ª–∞–∂–∞–Ω ‚Üí –ë–∞—è–ª–¥—ã
- –¶—É–∫–∫–∏–Ω–∏ ‚Üí –ö”ô–¥—ñ
- –®–ø–∏–Ω–∞—Ç ‚Üí –ê—Å–∂–∞–ø—ã—Ä–∞“õ
- –ü–æ–º–∏–¥–æ—Ä—ã ‚Üí “ö—ã–∑–∞–Ω–∞“õ
- –∑–µ–ª–µ–Ω—å ‚Üí –∞—Å—à”©–ø
- —É–∫—Ä–æ–ø ‚Üí –∞—Å–∫”©–∫
- —Å–µ–ª—å–¥–µ—Ä–µ–π ‚Üí –±–∞–ª–¥—ã—Ä–∫”©–∫
- —Ä–µ–¥–∏—Å ‚Üí —à–∞–ª“ì–∞–º

–ú—è—Å–æ:
- –ö–æ–Ω–∏–Ω–∞ ‚Üí –ñ—ã–ª“õ—ã –µ—Ç—ñ
- –¢–µ–ª—è—Ç–∏–Ω–∞ ‚Üí –ë“±–∑–∞—É
- –Ø–≥–Ω–µ–Ω–æ–∫ ‚Üí “ö–æ–∑—ã
- –æ—Ç–±–∏–≤–Ω–∞—è ‚Üí –∂–∞–Ω—à—ã–º–∞
- –∫–æ—Å—Ç–Ω—ã–π –º–æ–∑–≥ ‚Üí –∂—ñ–ª—ñ–∫ –º–∞–π
- —Ç—Ä–µ–±—É—Ö–∞ ‚Üí —ñ—à–µ–∫-“õ–∞—Ä—ã–Ω
- –∞–Ω—Ç—Ä–µ–∫–æ—Ç ‚Üí “õ–∞–±—ã—Ä“ì–∞ –µ—Ç
- –∫–æ—Ä–µ–π–∫–∞ ‚Üí –∂–∞—É—ã—Ä—ã–Ω –µ—Ç

–ü—Ä–æ—á–µ–µ:
- –°–≤–µ–∂–∏–π ‚Üí –ë–∞–ª“ì—ã–Ω
- –°–≤–µ–∂–µ–≤—ã–ø–µ—á–µ–Ω–Ω—ã–π ‚Üí –ñ–∞“£–∞ –ø—ñ—Å–∫–µ–Ω
- –Ø–π—Ü–æ –ø–∞—à–æ—Ç ‚Üí –ü–∞—à–æ—Ç –∂“±–º—ã—Ä—Ç“õ–∞—Å—ã
- –°—ã—Ä–Ω–∏–∫–∏ ‚Üí –°“Ø–∑–±–µ —ñ—Ä—ñ–º—à—ñ–∫—Ç–µ—Ä—ñ
- –°–ª–∏–≤–∫–∏ ‚Üí –ö—ñ–ª–µ–≥–µ–π
- –°–æ—É—Å ‚Üí –¢“±–∑–¥—ã“õ
- –®–∞–º–ø–∏–Ω—å–æ–Ω ‚Üí “ö–æ–∑—ã“õ“±–π—Ä—ã“õ
- —Å–æ–ª—è–Ω–∫–∞ ‚Üí –∞—â—ã —Å–æ—Ä–ø–∞
- —Ö–æ–ª–æ–¥–µ—Ü ‚Üí —Ç–æ“£–∞–∑—ã–º–∞
- –æ–ø—è—Ç–∞ ‚Üí —Ç–æ–º–∞—Ä“õ“±–ª–∞“õ
- —Ñ–∞—Å–æ–ª—å ‚Üí “Ø—Ä–º–µ–±“±—Ä—à–∞“õ

–¢–µ–∫—Å—Ç –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞:
${text}
`;
    }

    // üá¨üáß –ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫
    else if (target === "en") {
      prompt = `
You are a professional translator. Always translate the given text into clear, natural, and fluent **English** language ‚Äî even if it looks similar to English.
Do not skip or repeat any words. Translate absolutely everything, including individual words, short phrases, and full sentences.
Keep **ALL** punctuation, capitalization, line breaks, parentheses, numbers, emojis, and symbols exactly as in the original text.
Do not simplify or interpret the meaning ‚Äî translate as accurately and literally as possible while keeping the natural flow of English.

–¢–µ–∫—Å—Ç –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞:
${text}
`;
    }

    // üá∏üá¶ –ê—Ä–∞–±—Å–∫–∏–π —è–∑—ã–∫
    else if (target === "ar") {
      prompt = `
–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–Ω—ã—Ö –º–µ–Ω—é.
–ü–µ—Ä–µ–≤–µ–¥–∏ —Ç–µ–∫—Å—Ç –Ω–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–π –ê—Ä–∞–±—Å–∫–∏–π —è–∑—ã–∫ (Modern Standard Arabic).
–£—á—Ç–∏ –∫—É–ª—å—Ç—É—Ä–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ (—Ö–∞–ª—è–ª—å –º–µ–Ω—é).
–°–æ—Ö—Ä–∞–Ω–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É, —Ü–∏—Ñ—Ä—ã –∏ —Ü–µ–Ω—ã (—Ü–∏—Ñ—Ä—ã –æ—Å—Ç–∞–≤—å –∞—Ä–∞–±—Å–∫–∏–º–∏ "123" –∏–ª–∏ –∏–Ω–¥–∏–π—Å–∫–∏–º–∏ "Ÿ°Ÿ¢Ÿ£" –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞, –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑—É–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ "123").
–¢–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω —á–∏—Ç–∞—Ç—å—Å—è —Å–ø—Ä–∞–≤–∞ –Ω–∞–ª–µ–≤–æ, –Ω–æ –≤ –æ—Ç–≤–µ—Ç–µ –ø—Ä–æ—Å—Ç–æ –≤–µ—Ä–Ω–∏ —Ç–µ–∫—Å—Ç.

–¢–µ–∫—Å—Ç –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞:
${text}
`;
    }

    // üåç –û–±—â–∏–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —è–∑—ã–∫–æ–≤
    else {
      prompt = `
–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–Ω—ã—Ö –º–µ–Ω—é.
–ü–µ—Ä–µ–≤–µ–¥–∏ —Ç–µ–∫—Å—Ç —Å ${source || "–æ–¥–Ω–æ–≥–æ"} —è–∑—ã–∫–∞ –Ω–∞ ${target || "–¥—Ä—É–≥–æ–π"} —è–∑—ã–∫.
–°–æ—Ö—Ä–∞–Ω–∏ –ø—É–Ω–∫—Ç—É–∞—Ü–∏—é, –∑–∞–≥–ª–∞–≤–Ω—ã–µ –±—É–∫–≤—ã, —Å–∏–º–≤–æ–ª—ã, –ø—Ä–æ–±–µ–ª—ã –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É.
–ù–µ –¥–æ–±–∞–≤–ª—è–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤, –ø–µ—Ä–µ–≤–æ–¥–∏ —Ç–æ—á–Ω–æ –∏ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ.

–¢–µ–∫—Å—Ç –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞:
${text}
`;
    }
    // =======================================================

    const result = await model.generateContent(prompt);

    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ
    const translation = result.response.text()?.trim() || "–ü–µ—Ä–µ–≤–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω";

    res.status(200).json({ translation });
  } catch (error) {
    console.error("‚ùå Vercel API Error:", error);
    res.status(500).json({ error: "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ Gemini API" });
  }
}
