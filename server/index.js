import dotenv from "dotenv";
import express from "express";
import cors from "cors";
import { GoogleGenerativeAI } from "@google/generative-ai";

dotenv.config();

const app = express();
app.use(cors());
app.use(express.json());

const apiKey = process.env.GEMINI_API_KEY;

// ðŸ§  ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ñ ÐºÐ»ÑŽÑ‡Ð°
if (!apiKey) {
  console.error("âŒ GEMINI_API_KEY Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² .env");
  process.exit(1);
}

const genAI = new GoogleGenerativeAI(apiKey);
const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });

// ðŸ“˜ ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´Ð°
app.post("/api/translate", async (req, res) => {
  try {
    const { text, source, target } = req.body;

    if (!text) {
      return res.status(400).json({ error: "Ð¢ÐµÐºÑÑ‚ Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½" });
    }

    let prompt = "";

    // ðŸŸ¡ ÐžÑ‚Ð´ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð¿Ñ€Ð¾Ð¼Ð¿Ñ‚ Ð´Ð»Ñ Ñ‚ÑƒÑ€ÐµÑ†ÐºÐ¾Ð³Ð¾ ÑÐ·Ñ‹ÐºÐ°
    if (target === "tr") {
      prompt = `
Ð¢Ñ‹ Ð¿Ñ€Ð¾Ñ„ÐµÑÑÐ¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´Ñ‡Ð¸Ðº Ñ€ÐµÑÑ‚Ð¾Ñ€Ð°Ð½Ð½Ñ‹Ñ… Ð¼ÐµÐ½ÑŽ.
ÐŸÐµÑ€ÐµÐ²ÐµÐ´Ð¸ Ñ‚ÐµÐºÑÑ‚ ÑÑ‚Ñ€Ð¾Ð³Ð¾ Ð½Ð° **Ð»Ð¸Ñ‚ÐµÑ€Ð°Ñ‚ÑƒÑ€Ð½Ñ‹Ð¹ Ñ‚ÑƒÑ€ÐµÑ†ÐºÐ¸Ð¹ ÑÐ·Ñ‹Ðº (Ð½Ð° Ð»Ð°Ñ‚Ð¸Ð½Ð¸Ñ†Ðµ)**.
ÐÐµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ ÐºÐ°Ð·Ð°Ñ…ÑÐºÐ¸Ðµ ÑÐ»Ð¾Ð²Ð° Ð¸ Ð¸Ð·Ð±ÐµÐ³Ð°Ð¹ Ð·Ð°Ð¸Ð¼ÑÑ‚Ð²Ð¾Ð²Ð°Ð½Ð¸Ð¹.
Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸ ÑÐ¼Ñ‹ÑÐ» Ð¸ ÑÑ‚Ð¸Ð»ÑŒ Ð¾Ñ€Ð¸Ð³Ð¸Ð½Ð°Ð»Ð°, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð·Ð²ÑƒÑ‡Ð°Ð»Ð¾ ÐµÑÑ‚ÐµÑÑ‚Ð²ÐµÐ½Ð½Ð¾ Ð´Ð»Ñ Ð½Ð¾ÑÐ¸Ñ‚ÐµÐ»ÐµÐ¹ Ñ‚ÑƒÑ€ÐµÑ†ÐºÐ¾Ð³Ð¾ ÑÐ·Ñ‹ÐºÐ°.
ÐŸÐµÑ€ÐµÐ²Ð¾Ð´Ð¸ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ Ð±Ð»ÑŽÐ´ Ð¸ Ð¸Ñ… Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ñ, Ð±ÐµÐ· Ð¿Ð¾ÑÑÐ½ÐµÐ½Ð¸Ð¹ Ð¸ ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸ÐµÐ².
Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸ Ð¿ÑƒÐ½ÐºÑ‚ÑƒÐ°Ñ†Ð¸ÑŽ, Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€ Ð¸ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ Ñ‚ÐµÐºÑÑ‚Ð°.
Ð¢ÐµÐºÑÑ‚ Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´Ð°:
${text}
`;
    }

    // ðŸŸ¢ ÐŸÑ€Ð¾Ð¼Ð¿Ñ‚ Ð´Ð»Ñ ÐºÐ°Ð·Ð°Ñ…ÑÐºÐ¾Ð³Ð¾ (ÑÐ¾ ÑÐ¿ÐµÑ†.ÑÐ»Ð¾Ð²Ð°Ð¼Ð¸)
    else if (target === "kk") {
      prompt = `
Ð¢Ñ‹ Ð¿Ñ€Ð¾Ñ„ÐµÑÑÐ¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´Ñ‡Ð¸Ðº Ñ€ÐµÑÑ‚Ð¾Ñ€Ð°Ð½Ð½Ñ‹Ñ… Ð¼ÐµÐ½ÑŽ.
Ð—Ð°Ð´Ð°Ñ‡Ð°: Ð¿ÐµÑ€ÐµÐ²ÐµÐ´Ð¸ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ Ð±Ð»ÑŽÐ´ Ð¸ Ð¸Ñ… Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ñ Ñ‚Ð°Ðº, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð·Ð²ÑƒÑ‡Ð°Ð» ÐµÑÑ‚ÐµÑÑ‚Ð²ÐµÐ½Ð½Ð¾ Ð´Ð»Ñ Ð½Ð¾ÑÐ¸Ñ‚ÐµÐ»ÐµÐ¹ ÐºÐ°Ð·Ð°Ñ…ÑÐºÐ¾Ð³Ð¾ ÑÐ·Ñ‹ÐºÐ°.
ÐÐµ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐ¹ Ð¿Ð¾ÑÑÐ½ÐµÐ½Ð¸Ð¹, ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸ÐµÐ² Ð¸ Ð½Ðµ Ð¼ÐµÐ½ÑÐ¹ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ Ñ‚ÐµÐºÑÑ‚Ð°.
Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸ Ð²ÑÐµ Ð·Ð½Ð°ÐºÐ¸ Ð¿Ñ€ÐµÐ¿Ð¸Ð½Ð°Ð½Ð¸Ñ, Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¸ Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€ Ð¾Ñ€Ð¸Ð³Ð¸Ð½Ð°Ð»Ð°.
Ð•ÑÐ»Ð¸ Ñ‚ÐµÐºÑÑ‚ Ð½ÑƒÐ¶Ð½Ð¾ Ð¿ÐµÑ€ÐµÐ²ÐµÑÑ‚Ð¸ Ð½Ð° ÐºÐ°Ð·Ð°Ñ…ÑÐºÐ¸Ð¹ â€” Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ ÑƒÐºÐ°Ð·Ð°Ð½Ð½Ñ‹Ðµ ÑÐ¿ÐµÑ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´Ñ‹:
Ð Ñ‹Ð±Ð°:
- Ð›Ð¾ÑÐ¾ÑÑŒ â†’ ÐÐ»Ð±Ñ‹Ñ€Ñ‚
- Ð¡ÐµÐ¼Ð³Ð° â†’ ÐÒ›ÑÐµÑ€ÐºÐµ
- Ð¡ÑƒÐ´Ð°Ðº â†’ ÐšÓ©ÐºÑÐµÑ€ÐºÐµ
- Ð¤Ð¾Ñ€ÐµÐ»ÑŒ â†’ Ð‘Ð°Ò›Ñ‚Ð°Ò›
- ÐžÑÐµÑ‚Ñ€ â†’ Ð‘ÐµÐºÑ–Ñ€Ðµ
- Ð¡Ð°Ð·Ð°Ð½ â†’ Ð¡Ð°Ð·Ð°Ð½ Ð±Ð°Ð»Ñ‹Ò›
- Ð£Ð³Ð¾Ñ€ÑŒ â†’ Ð–Ñ‹Ð»Ð°Ð½Ð±Ð°Ð»Ñ‹Ò›

ÐœÐ¾Ñ€ÐµÐ¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ñ‹:
- ÐšÑ€ÐµÐ²ÐµÑ‚ÐºÐ° â†’ ÐÑÑˆÐ°ÑÐ½
- ÐœÐ¸Ð´Ð¸Ñ â†’ ÐœÐ¸Ð´Ð¸Ñ
- Ð£ÑÑ‚Ñ€Ð¸Ñ†Ð° â†’ Ð£ÑÑ‚Ñ€Ð¸Ñ†Ð°
- ÐšÑ€Ð°Ð± â†’ Ð¢ÐµÒ£Ñ–Ð· ÑˆÐ°ÑÐ½Ñ‹
- Ð Ð°Ðº â†’ Ð¡Ñƒ ÑˆÐ°ÑÐ½

ÐžÐ²Ð¾Ñ‰Ð¸:
- Ð‘Ð°ÐºÐ»Ð°Ð¶Ð°Ð½ â†’ Ð‘Ð°ÑÐ»Ð´Ñ‹
- Ð¦ÑƒÐºÐºÐ¸Ð½Ð¸ (ÐšÐ°Ð±Ð°Ñ‡ÐºÐ¸) â†’ ÐšÓ™Ð´Ñ–
- Ð¨Ð¿Ð¸Ð½Ð°Ñ‚ â†’ ÐÑÐ¶Ð°Ð¿Ñ‹Ñ€Ð°Ò›
- ÐŸÐ¾Ð¼Ð¸Ð´Ð¾Ñ€Ñ‹ â†’ ÒšÑ‹Ð·Ð°Ð½Ð°Ò›

ÐœÑÑÐ¾:
- ÐšÐ¾Ð½Ð¸Ð½Ð° â†’ Ð–Ñ‹Ð»Ò›Ñ‹ ÐµÑ‚Ñ–
- Ð¢ÐµÐ»ÑÑ‚Ð¸Ð½Ð° â†’ Ð‘Ò±Ð·Ð°Ñƒ
- Ð¯Ð³Ð½ÐµÐ½Ð¾Ðº â†’ ÒšÐ¾Ð·Ñ‹

ÐŸÑ€Ð¾Ñ‡ÐµÐµ:
- Ð¡Ð²ÐµÐ¶Ð¸Ð¹ (Ð¿Ñ€Ð¾ Ð¾Ð²Ð¾Ñ‰Ð¸) â†’ Ð‘Ð°Ð»Ò“Ñ‹Ð½
- Ð¡Ð²ÐµÐ¶ÐµÐ²Ñ‹Ð¿ÐµÑ‡ÐµÐ½Ð½Ñ‹Ð¹ (Ñ…Ð»ÐµÐ±) â†’ Ð–Ð°Ò£Ð° Ð¿Ñ–ÑÐºÐµÐ½
- Ð¯Ð¹Ñ†Ð¾ Ð¿Ð°ÑˆÐ¾Ñ‚ â†’ ÐŸÐ°ÑˆÐ¾Ñ‚ Ð¶Ò±Ð¼Ñ‹Ñ€Ñ‚Ò›Ð°ÑÑ‹
- Ð¡Ñ‹Ñ€Ð½Ð¸ÐºÐ¸ â†’ Ð¡Ò¯Ð·Ð±Ðµ Ñ–Ñ€Ñ–Ð¼ÑˆÑ–ÐºÑ‚ÐµÑ€Ñ–
- Ð¡Ð»Ð¸Ð²ÐºÐ¸ â†’ ÐšÑ–Ð»ÐµÐ³ÐµÐ¹
- Ð¡Ð¾ÑƒÑ, ÑÐ¾ÑƒÑÑ‹ â†’ Ð¢Ò±Ð·Ð´Ñ‹Ò›

ÐŸÐµÑ€ÐµÐ²ÐµÐ´Ð¸ Ñ‚ÐµÐºÑÑ‚ Ð½Ð¸Ð¶Ðµ ÑÑ‚Ñ€Ð¾Ð³Ð¾ Ð¿Ð¾ ÑÐ¼Ñ‹ÑÐ»Ñƒ, ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÑ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚ Ð±Ð»ÑŽÐ´Ð°.

Ð¢ÐµÐºÑÑ‚ Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´Ð°:
${text}
`;
    }

    // âšª ÐŸÑ€Ð¾Ð¼Ð¿Ñ‚ Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ (Ð´Ñ€ÑƒÐ³Ð¸Ðµ ÑÐ·Ñ‹ÐºÐ¸)
    else {
      prompt = `
Ð¢Ñ‹ Ð¿Ñ€Ð¾Ñ„ÐµÑÑÐ¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´Ñ‡Ð¸Ðº Ñ€ÐµÑÑ‚Ð¾Ñ€Ð°Ð½Ð½Ñ‹Ñ… Ð¼ÐµÐ½ÑŽ.
ÐŸÐµÑ€ÐµÐ²ÐµÐ´Ð¸ Ñ‚ÐµÐºÑÑ‚ Ñ ${source || "Ð¾Ð´Ð½Ð¾Ð³Ð¾"} ÑÐ·Ñ‹ÐºÐ° Ð½Ð° ${target || "Ð´Ñ€ÑƒÐ³Ð¾Ð¹"} ÑÐ·Ñ‹Ðº.
ÐŸÐµÑ€ÐµÐ²Ð¾Ð´Ð¸ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ Ð±Ð»ÑŽÐ´ Ð¸ Ð¸Ñ… Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ñ, ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÑ ÑÐ¼Ñ‹ÑÐ» Ð¸ Ð·Ð²ÑƒÑ‡Ð°Ð½Ð¸Ðµ.
ÐÐµ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐ¹ Ð¿Ð¾ÑÑÐ½ÐµÐ½Ð¸Ð¹, ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸ÐµÐ² Ð¸ Ð½Ðµ Ð¸Ð·Ð¼ÐµÐ½ÑÐ¹ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ Ñ‚ÐµÐºÑÑ‚Ð°.
Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸ Ð°Ð±ÑÐ¾Ð»ÑŽÑ‚Ð½Ð¾ Ð²ÑÑŽ Ð¿ÑƒÐ½ÐºÑ‚ÑƒÐ°Ñ†Ð¸ÑŽ, Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€ (Ð·Ð°Ð³Ð»Ð°Ð²Ð½Ñ‹Ðµ/ÑÑ‚Ñ€Ð¾Ñ‡Ð½Ñ‹Ðµ Ð±ÑƒÐºÐ²Ñ‹), Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¸ Ñ€Ð°ÑÐ¿Ð¾Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð², ÐºÐ°Ðº Ð² Ð¾Ñ€Ð¸Ð³Ð¸Ð½Ð°Ð»Ðµ.
Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð²Ð¸Ð·ÑƒÐ°Ð»ÑŒÐ½Ð¾ Ð¸Ð´ÐµÐ½Ñ‚Ð¸Ñ‡ÐµÐ½ Ð¸ÑÑ…Ð¾Ð´Ð½Ð¾Ð¼Ñƒ Ñ‚ÐµÐºÑÑ‚Ñƒ, Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½Ð° Ð´Ñ€ÑƒÐ³Ð¾Ð¼ ÑÐ·Ñ‹ÐºÐµ.

Ð¢ÐµÐºÑÑ‚ Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´Ð°:
${text}
`;
    }

    // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð² Gemini
    const result = await model.generateContent(prompt);

    // ðŸ’¡ Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ Ñ‚ÐµÐºÑÑ‚ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´Ð° Ð¸Ð· Ð¾Ñ‚Ð²ÐµÑ‚Ð°
    const translation =
      result?.response?.candidates?.[0]?.content?.parts?.[0]?.text?.trim() ||
      "ÐŸÐµÑ€ÐµÐ²Ð¾Ð´ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½";

    res.json({ translation });
  } catch (error) {
    console.error("âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Gemini API:", error.message || error);
    res.status(500).json({ error: "ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ð¸ Ðº Gemini API" });
  }
});

const port = process.env.PORT || 5000;
app.listen(port, () => console.log(`âœ… Ð¡ÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ ${port}`));
