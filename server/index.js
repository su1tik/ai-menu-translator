import dotenv from "dotenv";
import express from "express";
import cors from "cors";
import { GoogleGenerativeAI } from "@google/generative-ai";

dotenv.config();

const app = express();
app.use(cors());
app.use(express.json());

const apiKey = process.env.GEMINI_API_KEY;

if (!apiKey) {
  console.error("âŒ GEMINI_API_KEY Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² .env");
  process.exit(1);
}

const genAI = new GoogleGenerativeAI(apiKey);
const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });

app.post("/api/translate", async (req, res) => {
  try {
    const { text, source, target } = req.body;

    if (!text) {
      return res.status(400).json({ error: "Ð¢ÐµÐºÑÑ‚ Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½" });
    }

    let prompt = "";

    // ðŸ‡¹ðŸ‡· Ð¢ÑƒÑ€ÐµÑ†ÐºÐ¸Ð¹ ÑÐ·Ñ‹Ðº
    if (target === "tr") {
      prompt = `
Ð¢Ñ‹ Ð¿Ñ€Ð¾Ñ„ÐµÑÑÐ¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´Ñ‡Ð¸Ðº Ñ€ÐµÑÑ‚Ð¾Ñ€Ð°Ð½Ð½Ñ‹Ñ… Ð¼ÐµÐ½ÑŽ.
ÐŸÐµÑ€ÐµÐ²ÐµÐ´Ð¸ Ñ‚ÐµÐºÑÑ‚ ÑÑ‚Ñ€Ð¾Ð³Ð¾ Ð½Ð° Ð»Ð¸Ñ‚ÐµÑ€Ð°Ñ‚ÑƒÑ€Ð½Ñ‹Ð¹ Ñ‚ÑƒÑ€ÐµÑ†ÐºÐ¸Ð¹ ÑÐ·Ñ‹Ðº (Ð»Ð°Ñ‚Ð¸Ð½Ð¸Ñ†Ð°).
ÐÐµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ ÐºÐ°Ð·Ð°Ñ…ÑÐºÐ¸Ðµ ÑÐ»Ð¾Ð²Ð°, ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐ¹ ÑÑ‚Ð¸Ð»ÑŒ Ð¸ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ Ñ‚ÐµÐºÑÑ‚Ð°.
Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸ Ð¿ÑƒÐ½ÐºÑ‚ÑƒÐ°Ñ†Ð¸ÑŽ, Ð·Ð°Ð³Ð»Ð°Ð²Ð½Ñ‹Ðµ Ð±ÑƒÐºÐ²Ñ‹, ÑÐºÐ¾Ð±ÐºÐ¸, ÑÐ¸Ð¼Ð²Ð¾Ð»Ñ‹ Ð¸ Ð¿Ñ€Ð¾Ð±ÐµÐ»Ñ‹.
ÐÐµ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐ¹ Ð¿Ð¾ÑÑÐ½ÐµÐ½Ð¸Ð¹, Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð¿ÐµÑ€ÐµÐ²ÐµÐ´Ð¸ Ñ‚ÐµÐºÑÑ‚.

Ð¢ÐµÐºÑÑ‚ Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´Ð°:
${text}
`;
    }

    // ðŸ‡°ðŸ‡¿ ÐšÐ°Ð·Ð°Ñ…ÑÐºÐ¸Ð¹ ÑÐ·Ñ‹Ðº
    else if (target === "kk") {
      prompt = `
Ð¢Ñ‹ Ð¿Ñ€Ð¾Ñ„ÐµÑÑÐ¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´Ñ‡Ð¸Ðº Ñ€ÐµÑÑ‚Ð¾Ñ€Ð°Ð½Ð½Ñ‹Ñ… Ð¼ÐµÐ½ÑŽ.
ÐŸÐµÑ€ÐµÐ²ÐµÐ´Ð¸ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ Ð±Ð»ÑŽÐ´ Ð¸ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ñ Ð½Ð° ÐºÐ°Ð·Ð°Ñ…ÑÐºÐ¸Ð¹ ÑÐ·Ñ‹Ðº Ñ‚Ð°Ðº, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð·Ð²ÑƒÑ‡Ð°Ð»Ð¾ ÐµÑÑ‚ÐµÑÑ‚Ð²ÐµÐ½Ð½Ð¾.
Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ, Ð¿ÑƒÐ½ÐºÑ‚ÑƒÐ°Ñ†Ð¸ÑŽ, Ð¿Ñ€Ð¾Ð±ÐµÐ»Ñ‹, Ð·Ð°Ð³Ð»Ð°Ð²Ð½Ñ‹Ðµ Ð±ÑƒÐºÐ²Ñ‹ Ð¸ ÑÐ¸Ð¼Ð²Ð¾Ð»Ñ‹.
ÐÐµ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐ¹ Ð¿Ð¾ÑÑÐ½ÐµÐ½Ð¸Ð¹ Ð¸Ð»Ð¸ Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ñ… ÑÐ»Ð¾Ð².
Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´Ñ‹, ÐµÑÐ»Ð¸ Ð¾Ð½Ð¸ Ð²ÑÑ‚Ñ€ÐµÑ‡Ð°ÑŽÑ‚ÑÑ:

Ð Ñ‹Ð±Ð°:
- Ð›Ð¾ÑÐ¾ÑÑŒ â†’ ÐÐ»Ð±Ñ‹Ñ€Ñ‚
- Ð¡ÐµÐ¼Ð³Ð° â†’ ÐÒ›ÑÐµÑ€ÐºÐµ
- Ð¡ÑƒÐ´Ð°Ðº â†’ ÐšÓ©ÐºÑÐµÑ€ÐºÐµ
- Ð¤Ð¾Ñ€ÐµÐ»ÑŒ â†’ Ð‘Ð°Ò›Ñ‚Ð°Ò›
- ÐžÑÐµÑ‚Ñ€ â†’ Ð‘ÐµÐºÑ–Ñ€Ðµ
- Ð¡Ð°Ð·Ð°Ð½ â†’ Ð¡Ð°Ð·Ð°Ð½ Ð±Ð°Ð»Ñ‹Ò›
- Ð£Ð³Ð¾Ñ€ÑŒ â†’ Ð–Ñ‹Ð»Ð°Ð½Ð±Ð°Ð»Ñ‹Ò›

ÐœÐ¾Ñ€ÐµÐ¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ñ‹:
- ÐšÑ€ÐµÐ²ÐµÑ‚ÐºÐ° â†’ ÐÑÑˆÐ°ÑÐ½
- ÐœÐ¸Ð´Ð¸Ñ â†’ ÐœÐ¸Ð´Ð¸Ñ
- Ð£ÑÑ‚Ñ€Ð¸Ñ†Ð° â†’ Ð£ÑÑ‚Ñ€Ð¸Ñ†Ð°
- ÐšÑ€Ð°Ð± â†’ Ð¢ÐµÒ£Ñ–Ð· ÑˆÐ°ÑÐ½Ñ‹
- Ð Ð°Ðº â†’ Ð¡Ñƒ ÑˆÐ°ÑÐ½

ÐžÐ²Ð¾Ñ‰Ð¸:
- Ð‘Ð°ÐºÐ»Ð°Ð¶Ð°Ð½ â†’ Ð‘Ð°ÑÐ»Ð´Ñ‹
- Ð¦ÑƒÐºÐºÐ¸Ð½Ð¸ â†’ ÐšÓ™Ð´Ñ–
- Ð¨Ð¿Ð¸Ð½Ð°Ñ‚ â†’ ÐÑÐ¶Ð°Ð¿Ñ‹Ñ€Ð°Ò›
- ÐŸÐ¾Ð¼Ð¸Ð´Ð¾Ñ€Ñ‹ â†’ ÒšÑ‹Ð·Ð°Ð½Ð°Ò›

ÐœÑÑÐ¾:
- ÐšÐ¾Ð½Ð¸Ð½Ð° â†’ Ð–Ñ‹Ð»Ò›Ñ‹ ÐµÑ‚Ñ–
- Ð¢ÐµÐ»ÑÑ‚Ð¸Ð½Ð° â†’ Ð‘Ò±Ð·Ð°Ñƒ
- Ð¯Ð³Ð½ÐµÐ½Ð¾Ðº â†’ ÒšÐ¾Ð·Ñ‹

ÐŸÑ€Ð¾Ñ‡ÐµÐµ:
- Ð¡Ð²ÐµÐ¶Ð¸Ð¹ â†’ Ð‘Ð°Ð»Ò“Ñ‹Ð½
- Ð¡Ð²ÐµÐ¶ÐµÐ²Ñ‹Ð¿ÐµÑ‡ÐµÐ½Ð½Ñ‹Ð¹ â†’ Ð–Ð°Ò£Ð° Ð¿Ñ–ÑÐºÐµÐ½
- Ð¯Ð¹Ñ†Ð¾ Ð¿Ð°ÑˆÐ¾Ñ‚ â†’ ÐŸÐ°ÑˆÐ¾Ñ‚ Ð¶Ò±Ð¼Ñ‹Ñ€Ñ‚Ò›Ð°ÑÑ‹
- Ð¡Ñ‹Ñ€Ð½Ð¸ÐºÐ¸ â†’ Ð¡Ò¯Ð·Ð±Ðµ Ñ–Ñ€Ñ–Ð¼ÑˆÑ–ÐºÑ‚ÐµÑ€Ñ–
- Ð¡Ð»Ð¸Ð²ÐºÐ¸ â†’ ÐšÑ–Ð»ÐµÐ³ÐµÐ¹
- Ð¡Ð¾ÑƒÑ â†’ Ð¢Ò±Ð·Ð´Ñ‹Ò›

Ð¢ÐµÐºÑÑ‚ Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´Ð°:
${text}
`;
    }

    // ðŸ‡¬ðŸ‡§ ÐÐ½Ð³Ð»Ð¸Ð¹ÑÐºÐ¸Ð¹ ÑÐ·Ñ‹Ðº
    else if (target === "en") {
      prompt = `
You are a professional translator. Always translate the given text into clear, natural, and fluent **English** language â€” even if it looks similar to English.
Do not skip or repeat any words. Translate absolutely everything, including individual words, short phrases, and full sentences.
Keep **ALL** punctuation, capitalization, line breaks, parentheses, numbers, emojis, and symbols exactly as in the original text.
Do not simplify or interpret the meaning â€” translate as accurately and literally as possible while keeping the natural flow of English.

Ð¢ÐµÐºÑÑ‚ Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´Ð°:
${text}
`;
    }

    // ðŸŒ ÐžÐ±Ñ‰Ð¸Ð¹ Ð¿Ñ€Ð¾Ð¼Ð¿Ñ‚ Ð´Ð»Ñ Ð¾ÑÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ñ… ÑÐ·Ñ‹ÐºÐ¾Ð²
    else {
      prompt = `
Ð¢Ñ‹ Ð¿Ñ€Ð¾Ñ„ÐµÑÑÐ¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´Ñ‡Ð¸Ðº Ñ€ÐµÑÑ‚Ð¾Ñ€Ð°Ð½Ð½Ñ‹Ñ… Ð¼ÐµÐ½ÑŽ.
ÐŸÐµÑ€ÐµÐ²ÐµÐ´Ð¸ Ñ‚ÐµÐºÑÑ‚ Ñ ${source || "Ð¾Ð´Ð½Ð¾Ð³Ð¾"} ÑÐ·Ñ‹ÐºÐ° Ð½Ð° ${target || "Ð´Ñ€ÑƒÐ³Ð¾Ð¹"} ÑÐ·Ñ‹Ðº.
Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸ Ð¿ÑƒÐ½ÐºÑ‚ÑƒÐ°Ñ†Ð¸ÑŽ, Ð·Ð°Ð³Ð»Ð°Ð²Ð½Ñ‹Ðµ Ð±ÑƒÐºÐ²Ñ‹, ÑÐ¸Ð¼Ð²Ð¾Ð»Ñ‹, Ð¿Ñ€Ð¾Ð±ÐµÐ»Ñ‹ Ð¸ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ.
ÐÐµ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐ¹ ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸ÐµÐ², Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´Ð¸ Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð¸ Ð°ÐºÐºÑƒÑ€Ð°Ñ‚Ð½Ð¾.

Ð¢ÐµÐºÑÑ‚ Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´Ð°:
${text}
`;
    }

    const result = await model.generateContent(prompt);

    const translation =
      result?.response?.candidates?.[0]?.content?.parts?.[0]?.text?.trim() ||
      "ÐŸÐµÑ€ÐµÐ²Ð¾Ð´ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½";

    res.json({ translation });
  } catch (error) {
    console.error("âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Gemini API:", error.message || error);
    res.status(500).json({ error: "ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ð¸ Ðº Gemini API" });
  }
});

const port = process.env.PORT || 5000;
app.listen(port, () => console.log(`âœ… Ð¡ÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ ${port}`));
